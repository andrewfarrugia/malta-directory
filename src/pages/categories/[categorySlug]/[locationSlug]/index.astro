---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import FAQBlock from "@/components/FAQBlock.astro";
import RelatedLinks from "@/components/RelatedLinks.astro";
import PageMastheadMedia from "@/components/PageMastheadMedia.astro";
import ContextRail from "@/components/ContextRail.astro";
import {
  getCategoryBySlug,
  getLocationBySlug,
  getGuidesByCategory,
  getGuidesByLocation
} from "@/lib/data";
import { getQualifiedCombos, getQualifiedComboEditorial } from "@/lib/combo";
import { buildSeo, clampMeta } from "@/lib/seo";
import { faqSchema } from "@/lib/schema";
import { getPexelsImage } from "@/lib/pexelsImagePipeline";

export const getStaticPaths = () =>
  getQualifiedCombos().map((combo) => ({
    params: { categorySlug: combo.categorySlug, locationSlug: combo.locationSlug }
  }));

const { categorySlug, locationSlug } = Astro.params;
const category = getCategoryBySlug(categorySlug!);
const location = getLocationBySlug(locationSlug!);

if (!category || !location) {
  throw new Error(`Missing combo context: ${categorySlug}/${locationSlug}`);
}

const combo = getQualifiedComboEditorial(category.slug, location.slug);
if (!combo) {
  throw new Error(`Combo not qualified: ${category.slug}/${location.slug}`);
}

const guidesByCategory = await getGuidesByCategory(category.slug, 4);
const guidesByLocation = await getGuidesByLocation(location.slug, 4);

const relatedGuides = [...guidesByCategory, ...guidesByLocation].filter(
  (guide, index, all) => all.findIndex((candidate) => candidate.slug === guide.slug) === index
);

const title = combo.titleOverride || `${category.pluralName} in ${location.name}, Malta`;
const description = combo.descriptionOverride ||
  `Compare ${category.pluralName.toLowerCase()} in ${location.name} with local pricing context and practical selection guidance.`;

const seo = buildSeo({
  path: `/categories/${category.slug}/${location.slug}/`,
  title,
  description: clampMeta(description)
});

const breadcrumbs = [
  { name: "Home", url: "/" },
  { name: "Categories", url: "/categories/" },
  { name: category.pluralName, url: `/categories/${category.slug}/` },
  { name: location.name, url: `/categories/${category.slug}/${location.slug}/` }
];

const guideLinks = relatedGuides.map((guide) => ({ title: guide.data.title, href: `/guides/${guide.slug}/` }));
const bodyParagraphs = combo.body.split(/\n\n+/).map((part) => part.trim()).filter(Boolean);
---
<BaseLayout seo={seo} breadcrumbs={breadcrumbs} extraSchemas={[faqSchema(combo.faqs)]}>
  <main class="template-main">
    <PageMastheadMedia
      kicker="Qualified locality hub"
      title={title}
      description={description}
      image={getPexelsImage(`featured-location-${location.slug}`, `${location.name} service locality in Malta`)}
      actions={[
        { href: `/categories/${category.slug}/`, label: `More ${category.pluralName}` },
        { href: `/locations/${location.slug}/`, label: `About ${location.name}`, variant: "secondary" }
      ]}
    />

    <section class="section">
      <div class="container prose">
        <Breadcrumbs items={breadcrumbs} />
        <p class="lead">{combo.uniqueIntro}</p>
        {combo.priceRange && (
          <div class="notice">
            <strong>Typical prices in {location.name}</strong>
            <p>{combo.priceRange}</p>
          </div>
        )}
        {bodyParagraphs.map((paragraph) => (
          <p>{paragraph}</p>
        ))}
      </div>
    </section>

    <ContextRail
      title="Visual pathways"
      items={[
        {
          title: `${category.pluralName} in Malta`,
          href: `/categories/${category.slug}/`,
          meta: "Category hub",
          image: getPexelsImage(`category-${category.slug}-hero`, `${category.pluralName} in Malta`)
        },
        {
          title: `Services in ${location.name}`,
          href: `/locations/${location.slug}/`,
          meta: "Location hub",
          image: getPexelsImage(`featured-location-${location.slug}`, `${location.name} in Malta`)
        },
        {
          title: `Guide: ${category.pluralName}`,
          href: `/guides/`,
          meta: "Editorial library",
          image: getPexelsImage(`guide-${category.slug}`, `${category.pluralName} guide visual in Malta`)
        },
        {
          title: "Browse all categories",
          href: "/categories/",
          meta: "Directory index",
          image: getPexelsImage("page-categories-index-hero", "Category index in Malta")
        }
      ]}
    />

    <FAQBlock faqs={combo.faqs} title={`FAQs: ${category.pluralName} in ${location.name}`} />

    <RelatedLinks title="Related guides" links={guideLinks} />
  </main>
</BaseLayout>
