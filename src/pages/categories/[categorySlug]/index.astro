---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import FAQBlock from "@/components/FAQBlock.astro";
import GuideCard from "@/components/GuideCard.astro";
import RelatedLinks from "@/components/RelatedLinks.astro";
import ContextRail from "@/components/ContextRail.astro";
import PageMastheadMedia from "@/components/PageMastheadMedia.astro";
import {
  getCategories,
  getCategoryBySlug,
  getTopLocations,
  getGuidesByCategory
} from "@/lib/data";
import { getPexelsImages, toPictureData, getPexelsImage } from "@/lib/pexelsImagePipeline";
import { isQualifiedCombo } from "@/lib/combo";
import { buildSeo, clampMeta } from "@/lib/seo";
import { faqSchema } from "@/lib/schema";

export const getStaticPaths = () => getCategories().map((category) => ({ params: { categorySlug: category.slug } }));

const { categorySlug } = Astro.params;
const category = getCategoryBySlug(categorySlug!);

if (!category) {
  throw new Error(`Category not found: ${categorySlug}`);
}

const topLocations = getTopLocations(12);
const guides = await getGuidesByCategory(category.slug, 6);
const visualRail = getPexelsImages([
  `category-${category.slug}-hero`,
  `category-${category.slug}-tile-1`,
  `category-${category.slug}-tile-2`
]).map(toPictureData);

const seo = buildSeo({
  path: `/categories/${category.slug}/`,
  title: `${category.pluralName} in Malta`,
  description: clampMeta(`Compare ${category.pluralName.toLowerCase()} in Malta with local guides, FAQs, and quality-filtered locality pages.`)
});

const breadcrumbs = [
  { name: "Home", url: "/" },
  { name: "Categories", url: "/categories/" },
  { name: category.pluralName, url: `/categories/${category.slug}/` }
];

const locationLinks = topLocations.map((location) => {
  const comboHref = `/categories/${category.slug}/${location.slug}/`;
  return {
    title: `${category.pluralName} in ${location.name}`,
    href: isQualifiedCombo(category.slug, location.slug) ? comboHref : `/locations/${location.slug}/`
  };
});

---
<BaseLayout seo={seo} breadcrumbs={breadcrumbs} extraSchemas={[faqSchema(category.faq)]}>
  <main class="template-main">
    <PageMastheadMedia
      kicker="Category hub"
      title={`${category.pluralName} in Malta`}
      description={category.intro}
      image={getPexelsImage(`category-${category.slug}-hero`, `${category.pluralName} in Malta`)}
      actions={[
        { href: "/locations/", label: "Browse locations", variant: "secondary" },
        { href: "/guides/", label: "Read guides" }
      ]}
    />

    <section class="section">
      <div class="container prose">
        <Breadcrumbs items={breadcrumbs} />
        <div class="visual-rail mt-sm">
          {visualRail.map((image) => (
            <figure>
              <picture>
                {image.hasWebp && <source type="image/webp" srcset={image.webpSrcset} />}
                <source type="image/jpeg" srcset={image.jpgSrcset} />
                <img src={image.src} alt={image.alt} width={image.width} height={image.height} loading="lazy" />
              </picture>
            </figure>
          ))}
        </div>
        {visualRail[0]?.photographer && visualRail[0]?.photographerUrl && (
          <p class="meta mt-sm">
            Photo by <a href={visualRail[0].photographerUrl} target="_blank" rel="noopener nofollow">{visualRail[0].photographer}</a> on Pexels
          </p>
        )}
        <p>
          Malta Service Hub helps you compare providers with practical criteria, not just ranking position. For this category, focus on service scope, response times, and clear cost breakdowns before you commit.
        </p>
        <h2>How to choose</h2>
        <ol>
          <li>Request written scope and exclusions.</li>
          <li>Compare at least two itemized quotes.</li>
          <li>Check warranty period and follow-up policy.</li>
          <li>Confirm timeline and escalation path.</li>
          <li>Keep invoices and communication in writing.</li>
        </ol>
      </div>
    </section>

    <ContextRail
      title="Top localities for this category"
      items={topLocations.slice(0, 4).map((location) => ({
        title: `${category.pluralName} in ${location.name}`,
        href: isQualifiedCombo(category.slug, location.slug)
          ? `/categories/${category.slug}/${location.slug}/`
          : `/locations/${location.slug}/`,
        meta: "Local comparison hub",
        image: getPexelsImage(`featured-location-${location.slug}`, `${location.name} in Malta`)
      }))}
    />

    <RelatedLinks title="Top areas in Malta" links={locationLinks.slice(0, 12)} />

    <section class="section section--muted">
      <div class="container">
        <h2>Related guides</h2>
        <div class="grid grid--cards">
          {guides.map((guide) => (
            <GuideCard
              title={guide.data.title}
              description={guide.data.description}
              href={`/guides/${guide.slug}/`}
              dateUpdated={guide.data.dateUpdated.toISOString()}
              image={getPexelsImage(`guide-${category.slug}`, `${guide.data.title} in Malta`)}
            />
          ))}
        </div>
      </div>
    </section>

    <FAQBlock faqs={category.faq} />
  </main>
</BaseLayout>
