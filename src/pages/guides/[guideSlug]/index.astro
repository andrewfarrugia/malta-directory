---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import RelatedLinks from "@/components/RelatedLinks.astro";
import ContextRail from "@/components/ContextRail.astro";
import PageMastheadMedia from "@/components/PageMastheadMedia.astro";
import { render } from "astro:content";
import { getGuides } from "@/lib/data";
import { getCategoryBySlug, getLocationBySlug } from "@/lib/data";
import { getPexelsImage, toPictureData } from "@/lib/pexelsImagePipeline";
import { buildSeo, clampMeta } from "@/lib/seo";
import { estimateReadTime } from "@/lib/utils";

export const getStaticPaths = async () => {
  const guides = await getGuides();
  return guides.map((guide) => ({ params: { guideSlug: guide.slug } }));
};

const { guideSlug } = Astro.params;
const guides = await getGuides();
const guide = guides.find((entry) => entry.slug === guideSlug);

if (!guide) {
  throw new Error(`Guide not found: ${guideSlug}`);
}

const { Content, headings } = await render(guide);

const seo = buildSeo({
  path: `/guides/${guide.slug}/`,
  title: guide.data.title,
  description: clampMeta(guide.data.description)
});

const breadcrumbs = [
  { name: "Home", url: "/" },
  { name: "Guides", url: "/guides/" },
  { name: guide.data.title, url: `/guides/${guide.slug}/` }
];

const relatedServices = guide.data.categorySlugs
  .map((slug) => getCategoryBySlug(slug))
  .filter(Boolean)
  .map((category) => ({
    title: `${category!.pluralName} in Malta`,
    href: `/categories/${category!.slug}/`
  }));

const relatedLocations = (guide.data.locationSlugs || [])
  .map((slug) => getLocationBySlug(slug))
  .filter(Boolean)
  .map((location) => ({
    title: `Services in ${location!.name}`,
    href: `/locations/${location!.slug}/`
  }));

const readTime = estimateReadTime(guide.body);
const primaryCategorySlug = guide.data.categorySlugs[0] || "local-services";
const guideHero = toPictureData(getPexelsImage(`guide-${primaryCategorySlug}`, `${guide.data.title} in Malta`));
const guidePickOne = toPictureData(
  getPexelsImage(`category-${primaryCategorySlug}-tile-1`, `${guide.data.title} visual context in Malta`)
);
const guidePickTwo = toPictureData(
  getPexelsImage(`category-${primaryCategorySlug}-tile-2`, `${guide.data.title} service context in Malta`)
);
---
<BaseLayout seo={seo} breadcrumbs={breadcrumbs}>
  <main class="template-main">
    <PageMastheadMedia
      kicker="Guide"
      title={guide.data.title}
      description={guide.data.description}
      image={getPexelsImage(`guide-${primaryCategorySlug}`, `${guide.data.title} in Malta`)}
      actions={[
        { href: "/guides/", label: "All guides", variant: "secondary" },
        { href: `/categories/${primaryCategorySlug}/`, label: "Category hub" }
      ]}
    />

    <section class="section">
      <div class="container read-grid">
        <article class="prose">
          <Breadcrumbs items={breadcrumbs} />
          <p class="meta">
            Updated {new Date(guide.data.dateUpdated).toLocaleDateString("en-MT")} Â· {readTime} min read
          </p>
          <figure class="guide-hero-media mt-sm">
            <picture>
              {guideHero.hasWebp && <source type="image/webp" srcset={guideHero.webpSrcset} />}
              <source type="image/jpeg" srcset={guideHero.jpgSrcset} />
              <img src={guideHero.src} alt={guideHero.alt} width={guideHero.width} height={guideHero.height} />
            </picture>
            {guideHero.photographer && guideHero.photographerUrl && (
              <figcaption class="meta">
                Photo by <a href={guideHero.photographerUrl} rel="noopener nofollow" target="_blank">{guideHero.photographer}</a> on Pexels
              </figcaption>
            )}
          </figure>
          <Content />

          <section class="mt-sm">
            <h2>Related visual picks</h2>
            <div class="guide-visual-picks">
              {[guidePickOne, guidePickTwo].map((image) => (
                <figure>
                  <picture>
                    {image.hasWebp && <source type="image/webp" srcset={image.webpSrcset} />}
                    <source type="image/jpeg" srcset={image.jpgSrcset} />
                    <img src={image.src} alt={image.alt} width={image.width} height={image.height} loading="lazy" />
                  </picture>
                </figure>
              ))}
            </div>
          </section>

          <section class="card mt-sm">
            <h2>Next step</h2>
            <p>Compare category and locality hubs, then request direct quotes from providers.</p>
            <a class="btn btn--primary" href="/categories/">Browse categories</a>
          </section>
        </article>

        <aside class="sidebar card">
          <h2>Table of contents</h2>
          <ul>
            {headings.map((heading) => (
              <li><a href={`#${heading.slug}`}>{heading.text}</a></li>
            ))}
          </ul>
        </aside>
      </div>
    </section>

    <ContextRail
      title="Keep exploring"
      items={[
        {
          title: "Browse all guides",
          href: "/guides/",
          meta: "Editorial index",
          image: getPexelsImage("page-guides-index-hero", "Malta guide index")
        },
        {
          title: "Category hubs",
          href: "/categories/",
          meta: "Service pathways",
          image: getPexelsImage("page-categories-index-hero", "Malta category index")
        },
        {
          title: "Location hubs",
          href: "/locations/",
          meta: "Local context",
          image: getPexelsImage("page-locations-index-hero", "Malta locations index")
        },
        {
          title: "Search directory",
          href: "/search/",
          meta: "Find faster",
          image: getPexelsImage("page-search-hero", "Search Malta services")
        }
      ]}
    />

    <RelatedLinks title="Related services" links={relatedServices} />
    <RelatedLinks title="Related locations" links={relatedLocations} />
  </main>
</BaseLayout>
