---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import PageMastheadMedia from "@/components/PageMastheadMedia.astro";
import { buildSeo } from "@/lib/seo";
import { getPexelsImage } from "@/lib/pexelsImagePipeline";

const seo = buildSeo({
  path: "/search/",
  title: "Search",
  description: "Search Malta Service Hub categories, locations, guides, and listings.",
  noindex: true
});

const breadcrumbs = [
  { name: "Home", url: "/" },
  { name: "Search", url: "/search/" }
];
---
<BaseLayout seo={seo} breadcrumbs={breadcrumbs}>
  <main>
    <PageMastheadMedia
      kicker="Search utility"
      title="Search"
      description="Search categories, locations, guides, and listings from one place. This utility page is excluded from indexing."
      image={getPexelsImage("page-search-hero", "Search Malta services")}
    />

    <section class="section">
      <div class="container">
        <Breadcrumbs items={breadcrumbs} />

        <form id="search-form" class="card mt-sm form-stack">
          <label class="field-label" for="query">Search term</label>
          <input class="input-control" id="query" name="query" type="search" />
          <label class="field-label" for="type">Type</label>
          <select class="input-control" id="type" name="type">
            <option value="all">All</option>
            <option value="category">Category</option>
            <option value="location">Location</option>
            <option value="combo">Combo</option>
            <option value="guide">Guide</option>
          </select>
          <button class="btn btn--primary" type="submit">Search</button>
        </form>

        <div id="results" class="search-results"></div>
      </div>
    </section>
  </main>

  <script is:inline>
    const form = document.getElementById("search-form");
    const results = document.getElementById("results");

    const render = (items) => {
      if (!results) return;
      if (items.length === 0) {
        results.innerHTML = "<p class='meta'>No results found.</p>";
        return;
      }

      results.innerHTML = items
        .map(
          (item) =>
            `<article class=\"card\"><h3><a href=\"${item.url}\">${item.title}</a></h3><p>${item.description || ""}</p><p class=\"meta\">${item.type}</p></article>`
        )
        .join("");
    };

    form?.addEventListener("submit", async (event) => {
      event.preventDefault();
      const formData = new FormData(form);
      const query = String(formData.get("query") || "").trim().toLowerCase();
      const type = String(formData.get("type") || "all");

      if (!query) {
        render([]);
        return;
      }

      const response = await fetch("/search-index.json");
      const docs = await response.json();

      const matches = docs
        .filter((doc) => (type === "all" ? true : doc.type === type))
        .map((doc) => {
          const haystack = `${doc.title} ${(doc.tags || []).join(" ")} ${doc.description || ""}`.toLowerCase();
          return {
            doc,
            score: haystack.includes(query) ? 1 : 0
          };
        })
        .filter((entry) => entry.score > 0)
        .map((entry) => entry.doc)
        .slice(0, 50);

      render(matches);
    });
  </script>
</BaseLayout>
