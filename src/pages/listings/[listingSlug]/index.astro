---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import ListingCard from "@/components/ListingCard.astro";
import ContextRail from "@/components/ContextRail.astro";
import PageMastheadMedia from "@/components/PageMastheadMedia.astro";
import { getListings, getListingBySlug, getCategoryBySlug, getLocationBySlug } from "@/lib/data";
import { getPexelsImage, toPictureData } from "@/lib/pexelsImagePipeline";
import { buildSeo, clampMeta } from "@/lib/seo";
import { localBusinessSchema } from "@/lib/schema";

export const getStaticPaths = () => getListings().map((listing) => ({ params: { listingSlug: listing.slug } }));

const { listingSlug } = Astro.params;
const listing = getListingBySlug(listingSlug!);

if (!listing) {
  throw new Error(`Listing not found: ${listingSlug}`);
}

const location = getLocationBySlug(listing.locationSlug);
const categories = listing.categorySlugs.map((slug) => getCategoryBySlug(slug)).filter(Boolean);
const similarListings = getListings()
  .filter(
    (candidate) =>
      candidate.slug !== listing.slug &&
      candidate.locationSlug === listing.locationSlug &&
      candidate.categorySlugs.some((slug) => listing.categorySlugs.includes(slug))
  )
  .slice(0, 6);
const listingImage = toPictureData(
  getPexelsImage(`category-${listing.categorySlugs[0] || "plumbers"}-hero`, `${listing.name} service visual in Malta`)
);

const seo = buildSeo({
  path: `/listings/${listing.slug}/`,
  title: `${listing.name} in ${location?.name || "Malta"}`,
  description: clampMeta(listing.shortDescription),
  noindex: true
});

const breadcrumbs = [
  { name: "Home", url: "/" },
  { name: "Listings", url: "/listings/" },
  { name: listing.name, url: `/listings/${listing.slug}/` }
];
---
<BaseLayout seo={seo} breadcrumbs={breadcrumbs} extraSchemas={[localBusinessSchema(listing)]}>
  <main>
    <PageMastheadMedia
      kicker="Listing profile"
      title={listing.name}
      description={listing.shortDescription}
      image={getPexelsImage(`category-${listing.categorySlugs[0] || "plumbers"}-hero`, `${listing.name} service visual in Malta`)}
      actions={[
        { href: "/listings/", label: "All listings", variant: "secondary" },
        { href: `/categories/${listing.categorySlugs[0] || "plumbers"}/`, label: "Category hub" }
      ]}
    />

    <section class="section">
      <div class="container prose">
        <Breadcrumbs items={breadcrumbs} />
        <p class="meta">Last reviewed on {new Date(listing.lastVerifiedDate).toLocaleDateString("en-MT")}</p>
        <p class="meta">
          This listing is independently compiled. We recommend confirming details directly with the provider.
        </p>
        <figure class="guide-hero-media mt-sm">
          <picture>
            {listingImage.hasWebp && <source type="image/webp" srcset={listingImage.webpSrcset} />}
            <source type="image/jpeg" srcset={listingImage.jpgSrcset} />
            <img src={listingImage.src} alt={listingImage.alt} width={listingImage.width} height={listingImage.height} />
          </picture>
          {listingImage.photographer && listingImage.photographerUrl && (
            <figcaption class="meta">
              Photo by <a href={listingImage.photographerUrl} rel="noopener nofollow" target="_blank">{listingImage.photographer}</a> on Pexels
            </figcaption>
          )}
        </figure>

        <div>
          {categories.map((category) => (
            <a class="chip" href={`/categories/${category!.slug}/`}>{category!.pluralName}</a>
          ))}
          {location && (
            <a class="chip" href={`/locations/${location.slug}/`}>{location.name}</a>
          )}
        </div>

        <h2>Contact and address</h2>
        <p>{listing.address.line1}, {listing.address.locality} {listing.address.postalCode}, {listing.address.country}</p>
        <ul>
          {listing.phone && (
            <li>
              Phone: <a href={`tel:${listing.phone}`} data-track="phone-click" data-track-label={listing.slug}>{listing.phone}</a>
            </li>
          )}
          {listing.email && (
            <li>
              Email: <a href={`mailto:${listing.email}`} data-track="email-click" data-track-label={listing.slug}>{listing.email}</a>
            </li>
          )}
          {listing.website && (
            <li>
              Website: <a href={listing.website} rel="nofollow noopener" target="_blank" data-track="outbound-listing" data-track-label={listing.slug}>{listing.website}</a>
            </li>
          )}
          {!listing.phone && !listing.email && !listing.website && (
            <li>Contact details not available.</li>
          )}
        </ul>

        {listing.openingHours && listing.openingHours.length > 0 && (
          <>
            <h2>Opening hours</h2>
            <ul>
              {listing.openingHours.map((slot) => (
                <li>{slot}</li>
              ))}
            </ul>
          </>
        )}

        <h2>Gallery</h2>
        <div class="grid grid--gallery">
          {listing.images.map((image, index) => (
            <img src={image} alt={`${listing.name} image ${index + 1}`} loading="lazy" />
          ))}
        </div>
      </div>
    </section>

    <ContextRail
      title="Continue your research"
      items={[
        {
          title: "All listings",
          href: "/listings/",
          meta: "Directory index",
          image: getPexelsImage("page-listings-index-hero", "Listing directory in Malta")
        },
        {
          title: `Services in ${location?.name || "Malta"}`,
          href: location ? `/locations/${location.slug}/` : "/locations/",
          meta: "Locality hub",
          image: getPexelsImage(`featured-location-${location?.slug || "valletta"}`, `${location?.name || "Malta"} in Malta`)
        },
        {
          title: "Category guides",
          href: "/guides/",
          meta: "Editorial support",
          image: getPexelsImage(`guide-${listing.categorySlugs[0] || "plumbers"}`, "Service guide in Malta")
        },
        {
          title: "Search",
          href: "/search/",
          meta: "Find alternatives",
          image: getPexelsImage("page-search-hero", "Search service providers")
        }
      ]}
    />

    <section class="section section--muted">
      <div class="container">
        <h2>Similar listings</h2>
        <div class="grid grid--cards">
          {similarListings.map((item) => (
            <ListingCard listing={item} />
          ))}
        </div>
      </div>
    </section>
  </main>
</BaseLayout>
