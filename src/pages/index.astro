---
import BaseLayout from "@/layouts/BaseLayout.astro";
import HubCard from "@/components/HubCard.astro";
import GuideCard from "@/components/GuideCard.astro";
import FeatureIconStrip from "@/components/FeatureIconStrip.astro";
import FeaturedServiceCards from "@/components/FeaturedServiceCards.astro";
import TrendingLocalitiesMosaic from "@/components/TrendingLocalitiesMosaic.astro";
import EditorialArticleCards from "@/components/EditorialArticleCards.astro";
import ContextRail from "@/components/ContextRail.astro";
import PageMastheadMedia from "@/components/PageMastheadMedia.astro";
import TestimonialBand from "@/components/TestimonialBand.astro";
import { getTopCategories, getTopLocations, getGuides } from "@/lib/data";
import { buildSeo, clampMeta } from "@/lib/seo";
import { getPexelsComponentMap, getPexelsImage } from "@/lib/pexelsImagePipeline";

const topCategories = getTopCategories(12);
const topLocations = getTopLocations(12);
const guides = (await getGuides()).slice(0, 10);
const map = getPexelsComponentMap();

const iconStripItems = map.homeIconStrip;

const featuredItems = map.homeFeatured.map((item) => ({
  ...item,
  image: getPexelsImage(item.id, `${item.title} in Malta`)
}));

const mosaicItems = map.homeMosaic.map((item) => ({
  ...item,
  image: getPexelsImage(item.id, `${item.title} locality in Malta`)
}));

const editorialItems = guides.slice(0, 3).map((guide) => {
  const primaryCategory = guide.data.categorySlugs[0] || "local-services";
  return {
    title: guide.data.title,
    href: `/guides/${guide.slug}/`,
    date: guide.data.datePublished.toISOString(),
    author: guide.data.author,
    image: getPexelsImage(`guide-${primaryCategory}`, `${guide.data.title} in Malta`)
  };
});

const seo = buildSeo({
  path: "/",
  title: "Malta Service Hub - Local directory and guides for Malta",
  description: clampMeta(
    "Browse independent Malta service categories, localities, and practical guides compiled for informational use."
  )
});
---
<BaseLayout seo={seo}>
  <main class="home-shell">
    <section class="home-block home-block--hero">
      <PageMastheadMedia
        kicker="Independent Malta directory"
        title="Browse everything."
        description="Find trusted local service pathways across Malta with visual hubs, practical guides, and locality-first comparison journeys."
        image={getPexelsImage("featured-location-valletta", "Valletta locality context in Malta")}
        actions={[
          { href: "/categories/", label: "Browse categories" },
          { href: "/locations/", label: "Explore locations", variant: "secondary" }
        ]}
      />
    </section>

    <section class="home-block home-block--kpi">
      <div class="container">
        <div class="kpi-list">
          <div class="kpi-item"><strong>12</strong><span>Service categories</span></div>
          <div class="kpi-item"><strong>12</strong><span>Malta localities</span></div>
          <div class="kpi-item"><strong>34+</strong><span>Editorial guides</span></div>
          <div class="kpi-item"><strong>Independent</strong><span>Directory research</span></div>
        </div>
      </div>
    </section>

    <section class="home-block home-block--centered">
      <div class="container home-lead-copy">
        <h2>We've cracked the code.</h2>
        <p class="prose">
          We publish independent informational content with locality context and practical comparison guidance. Combined locality pages are only published when they pass editorial utility thresholds.
        </p>
      </div>
    </section>

    <section class="home-block home-block--process">
      <FeatureIconStrip title="Popular services to browse" seeAllHref="/categories/" items={iconStripItems} />
    </section>

    <section class="home-block home-block--split">
      <FeaturedServiceCards title="Featured locality hubs" items={featuredItems} />
    </section>

    <section class="home-block home-block--image-wide">
      <TrendingLocalitiesMosaic title="Trending localities" seeAllHref="/locations/" items={mosaicItems} />
    </section>

    <section class="home-block home-block--split-alt">
      <ContextRail
        title="See the big picture"
        items={topCategories.slice(0, 4).map((category) => ({
          title: `${category.pluralName} in Malta`,
          href: `/categories/${category.slug}/`,
          meta: category.synonyms[0] || "Category hub",
          image: getPexelsImage(`category-${category.slug}-hero`, `${category.pluralName} in Malta`)
        }))}
      />
    </section>

    <section class="home-block home-block--editorial">
      <EditorialArticleCards title="Latest practical guides" seeAllHref="/guides/" items={editorialItems} />
    </section>

    <section class="home-block home-block--credibility">
      <TestimonialBand />
    </section>

    <section class="home-block home-block--centered home-block--divider">
      <div class="container home-lead-copy">
        <h2>Why Choose Area?</h2>
        <p class="prose">
          Every page is designed to lead you through decisions with less noise: categories, localities, practical guides, and clear next steps.
        </p>
      </div>
    </section>

    <section class="home-block home-block--cards">
      <div class="container">
        <h2>Top categories</h2>
        <div class="grid grid--cards home-cards-grid">
          {topCategories.map((category) => (
            <HubCard
              title={`${category.pluralName} in Malta`}
              description={category.intro}
              href={`/categories/${category.slug}/`}
              chips={category.synonyms.slice(0, 3)}
              image={getPexelsImage(`category-${category.slug}-tile-1`, `${category.pluralName} service tools in Malta`)}
            />
          ))}
        </div>
      </div>
    </section>

    <section class="home-block home-block--cards home-block--muted">
      <div class="container">
        <h2>Top locations</h2>
        <div class="grid grid--cards home-cards-grid">
          {topLocations.map((location) => (
            <HubCard
              title={`Services in ${location.name}`}
              description={location.intro}
              href={`/locations/${location.slug}/`}
              chips={location.region ? [location.region] : []}
              image={getPexelsImage(`featured-location-${location.slug}`, `${location.name} locality in Malta`)}
            />
          ))}
        </div>
      </div>
    </section>

    <section class="home-block home-block--cards">
      <div class="container">
        <h2>Latest guides</h2>
        <div class="grid grid--cards home-cards-grid">
          {guides.map((guide) => (
            <GuideCard
              title={guide.data.title}
              description={guide.data.description}
              href={`/guides/${guide.slug}/`}
              dateUpdated={guide.data.dateUpdated.toISOString()}
              image={getPexelsImage(`guide-${guide.data.categorySlugs[0] || "plumbers"}`, `${guide.data.title} in Malta`)}
            />
          ))}
        </div>
      </div>
    </section>

    <section class="home-block home-block--cta">
      <div class="container home-cta-wrap">
        <h2>Connect with us</h2>
        <a class="btn btn--primary" href="/contact/">Start your request</a>
      </div>
    </section>
  </main>
</BaseLayout>
