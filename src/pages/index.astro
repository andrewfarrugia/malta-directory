---
import BaseLayout from "@/layouts/BaseLayout.astro";
import HubCard from "@/components/HubCard.astro";
import GuideCard from "@/components/GuideCard.astro";
import FeatureIconStrip from "@/components/FeatureIconStrip.astro";
import FeaturedServiceCards from "@/components/FeaturedServiceCards.astro";
import TrendingLocalitiesMosaic from "@/components/TrendingLocalitiesMosaic.astro";
import EditorialArticleCards from "@/components/EditorialArticleCards.astro";
import { getTopCategories, getTopLocations, getGuides } from "@/lib/data";
import { buildSeo, clampMeta } from "@/lib/seo";
import { getPexelsComponentMap, getPexelsImage } from "@/lib/pexelsImagePipeline";

const topCategories = getTopCategories(12);
const topLocations = getTopLocations(12);
const guides = (await getGuides()).slice(0, 10);
const map = getPexelsComponentMap();

const iconStripItems = map.homeIconStrip;

const featuredItems = map.homeFeatured.map((item) => ({
  ...item,
  image: getPexelsImage(item.id, `${item.title} in Malta`)
}));

const mosaicItems = map.homeMosaic.map((item) => ({
  ...item,
  image: getPexelsImage(item.id, `${item.title} locality in Malta`)
}));

const editorialItems = guides.slice(0, 3).map((guide) => {
  const primaryCategory = guide.data.categorySlugs[0] || "local-services";
  return {
    title: guide.data.title,
    href: `/guides/${guide.slug}/`,
    date: guide.data.datePublished.toISOString(),
    author: guide.data.author,
    image: getPexelsImage(`guide-${primaryCategory}`, `${guide.data.title} in Malta`)
  };
});

const seo = buildSeo({
  path: "/",
  title: "Malta Service Hub - Local directory and guides for Malta",
  description: clampMeta(
    "Browse independent Malta service categories, localities, and practical guides compiled for informational use."
  )
});
---
<BaseLayout seo={seo}>
  <main>
    <section class="hero">
      <div class="container">
        <h1>Browse independent service guides and locality hubs across Malta</h1>
        <p class="lead">
          Malta Service Hub is an independently curated directory and guide resource. Information is compiled from publicly available sources and may change over time.
        </p>
        <div class="consent-actions mt-sm">
          <a class="btn btn--primary" href="/categories/">Browse categories</a>
          <a class="btn btn--secondary" href="/locations/">Explore locations</a>
        </div>
        <div class="kpi-list mt-md">
          <div class="kpi-item"><strong>12</strong><br />Service categories</div>
          <div class="kpi-item"><strong>12</strong><br />Malta localities</div>
          <div class="kpi-item"><strong>34+</strong><br />Editorial guides</div>
          <div class="kpi-item"><strong>Independent</strong><br />Directory research</div>
        </div>
      </div>
    </section>

    <FeatureIconStrip title="Popular services to browse" seeAllHref="/categories/" items={iconStripItems} />
    <FeaturedServiceCards title="Featured locality hubs" items={featuredItems} />
    <TrendingLocalitiesMosaic title="Trending localities" seeAllHref="/locations/" items={mosaicItems} />
    <EditorialArticleCards title="Latest practical guides" seeAllHref="/guides/" items={editorialItems} />

    <section class="section">
      <div class="container">
        <h2>Top categories</h2>
        <div class="grid grid--cards">
          {topCategories.map((category) => (
            <HubCard
              title={`${category.pluralName} in Malta`}
              description={category.intro}
              href={`/categories/${category.slug}/`}
              chips={category.synonyms.slice(0, 3)}
            />
          ))}
        </div>
      </div>
    </section>

    <section class="section section--muted">
      <div class="container">
        <h2>Top locations</h2>
        <div class="grid grid--cards">
          {topLocations.map((location) => (
            <HubCard
              title={`Services in ${location.name}`}
              description={location.intro}
              href={`/locations/${location.slug}/`}
              chips={location.region ? [location.region] : []}
            />
          ))}
        </div>
      </div>
    </section>

    <section class="section">
      <div class="container">
        <h2>Latest guides</h2>
        <div class="grid grid--cards">
          {guides.map((guide) => (
            <GuideCard
              title={guide.data.title}
              description={guide.data.description}
              href={`/guides/${guide.slug}/`}
              dateUpdated={guide.data.dateUpdated.toISOString()}
            />
          ))}
        </div>
      </div>
    </section>

    <section class="section section--muted">
      <div class="container">
        <h2>How we rank and curate</h2>
        <p class="prose">
          We publish independent informational content with locality context and practical comparison guidance. Combined locality pages are only published when they pass editorial utility thresholds. Directory details may change and should always be confirmed directly with providers.
        </p>
        <div class="notice">
          Suggest a business or request an update via <a href="/contact/">our contact page</a>.
        </div>
      </div>
    </section>
  </main>
</BaseLayout>
